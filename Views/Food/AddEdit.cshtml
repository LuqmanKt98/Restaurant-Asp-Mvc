@model WebRestoran.Models.Food

@{
    ViewData["Title"] = Model.FoodId == 0 ? "Add New Menu Item" : "Edit Menu Item";
    string operation = Model.FoodId == 0 ? "Add New" : "Edit";
}

<!-- Page Header -->
<div class="hero-section bg-gradient-primary">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="hero-content">
                    <h1 class="hero-title">
                        <i class="bi @(Model.FoodId == 0 ? "bi-plus-circle" : "bi-pencil-square") me-3"></i>@operation Menu Item
                    </h1>
                    <p class="hero-subtitle">@(Model.FoodId == 0 ? "Create a new delicious menu item" : "Update your menu item details")</p>
                </div>
            </div>
            <div class="col-lg-4 text-lg-end">
                <a asp-action="Index" asp-controller="Food" class="btn btn-modern btn-light">
                    <i class="bi bi-arrow-left me-2"></i>Back to Menu
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Form Content -->
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card-modern">
                <div class="card-header bg-white border-bottom-0 py-4">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2 text-primary"></i>Menu Item Details
                    </h4>
                </div>
                <div class="card-body p-4">
                    <form asp-action="AddEdit" method="post" enctype="multipart/form-data" id="foodForm">
                        <input type="hidden" asp-for="FoodId" />
                        <input type="hidden" asp-for="CategoryId" />

                        <!-- Basic Information Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="section-title">
                                    <i class="bi bi-card-text me-2"></i>Basic Information
                                </h5>
                                <hr class="section-divider">
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label asp-for="FoodName" class="form-label-modern">
                                        <i class="bi bi-card-heading me-2"></i>Food Name
                                    </label>
                                    <input asp-for="FoodName" class="form-control-modern" placeholder="Enter food name" />
                                    <span asp-validation-for="FoodName" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group-modern">
                                    <label asp-for="Price" class="form-label-modern">
                                        <i class="bi bi-currency-euro me-2"></i>Price (â‚¬)
                                    </label>
                                    <input asp-for="Price" class="form-control-modern" step="0.01" placeholder="0.00" data-val="true" data-val-price="Please enter a valid price." />
                                    <span asp-validation-for="Price" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="form-group-modern">
                                    <label asp-for="Description" class="form-label-modern">
                                        <i class="bi bi-text-paragraph me-2"></i>Description
                                    </label>
                                    <textarea asp-for="Description" class="form-control-modern" placeholder="Enter description" style="height: 100px;"></textarea>
                                    <span asp-validation-for="Description" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group-modern">
                                    <label asp-for="Stock" class="form-label-modern">
                                        <i class="bi bi-box-seam me-2"></i>Stock Quantity
                                    </label>
                                    <input asp-for="Stock" class="form-control-modern" placeholder="0" />
                                    <span asp-validation-for="Stock" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Image Upload Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="section-title">
                                    <i class="bi bi-image me-2"></i>Image
                                </h5>
                                <hr class="section-divider">
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="upload-area">
                                    <input type="file" class="form-control" id="imageUpload" name="ImageFile" asp-for="ImageFile" accept="image/*" />
                                    <div class="upload-text">
                                        <i class="bi bi-cloud-upload display-4 text-muted mb-3"></i>
                                        <p class="mb-2">Click to upload or drag and drop</p>
                                        <small class="text-muted">PNG, JPG, GIF up to 10MB</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                                {
                                    <div class="current-image">
                                        <label class="form-label fw-bold mb-2">
                                            <i class="bi bi-image me-2"></i>Current Image:
                                        </label>
                                        <div class="image-preview">
                                            <img src="@Model.ImageUrl" alt="Current Image" class="img-fluid rounded shadow-sm" />
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="no-image text-center py-4">
                                        <i class="bi bi-image display-1 text-muted mb-3"></i>
                                        <p class="text-muted">No image uploaded yet</p>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Category and Ingredients Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="section-title">
                                    <i class="bi bi-tags me-2"></i>Category & Ingredients
                                </h5>
                                <hr class="section-divider">
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="category-section">
                                    <label class="form-label fw-bold mb-3">
                                        <i class="bi bi-bookmark me-2"></i>Category *
                                    </label>
                                    <div class="category-options">
                                        @foreach (Category category in ViewBag.Categories)
                                        {
                                            var isChecked = Model.CategoryId == category.CategoryId;
                                            <div class="form-check category-option">
                                                <input type="radio" class="form-check-input" id="category_@category.CategoryId" name="catId" value="@category.CategoryId" @(isChecked ? "checked" : "") />
                                                <label class="form-check-label" for="category_@category.CategoryId">
                                                    <span class="category-name">@category.CategoryName</span>
                                                </label>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="ingredients-section">
                                    <label class="form-label fw-bold mb-3">
                                        <i class="bi bi-list-check me-2"></i>Ingredients *
                                    </label>
                                    <div class="ingredients-container">
                                        @foreach (Ingredient ingredient in ViewBag.Ingredients)
                                        {
                                            var isChecked = Model.FoodIngredients != null && Model.FoodIngredients.Any(i => i.IngredientId == ingredient.IngredientId);
                                            <div class="form-check ingredient-option">
                                                <input type="checkbox" class="form-check-input" id="ingredient_@ingredient.IngredientId"
                                                       name="ingredientIds" value="@ingredient.IngredientId" @(isChecked ? "checked" : "") />
                                                <label class="form-check-label" for="ingredient_@ingredient.IngredientId">
                                                    <span class="ingredient-name">@ingredient.IngredientName</span>
                                                </label>
                                            </div>
                                        }
                                    </div>
                                    <span asp-validation-for="FoodIngredients" class="text-danger small"></span>
                                    <div id="ingredientError" class="text-danger small" style="display: none;">At least one ingredient must be selected.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row">
                            <div class="col-12">
                                <div class="form-actions text-center pt-4 border-top">
                                    <button type="submit" class="btn-modern btn-primary me-3" id="submitBtn">
                                        <i class="bi bi-check-circle me-2"></i>@(Model.FoodId == 0 ? "Create Menu Item" : "Update Menu Item")
                                    </button>
                                    <a asp-action="Index" asp-controller="Food" class="btn-modern btn-outline">
                                        <i class="bi bi-x-circle me-2"></i>Cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("foodForm");
            const submitBtn = document.getElementById("submitBtn");
            const imageUpload = document.getElementById("imageUpload");
            const ingredientError = document.getElementById("ingredientError");

            // Enhanced form validation
            form.addEventListener("submit", function (event) {
                let isValid = true;
                
                // Check ingredients selection
                const checkboxes = document.querySelectorAll("input[name='ingredientIds']:checked");
                if (checkboxes.length === 0) {
                    ingredientError.style.display = "block";
                    isValid = false;
                } else {
                    ingredientError.style.display = "none";
                }
                
                // Check category selection
                const categoryRadios = document.querySelectorAll("input[name='catId']:checked");
                if (categoryRadios.length === 0) {
                    alert("Please select a category.");
                    isValid = false;
                }
                
                if (!isValid) {
                    event.preventDefault();
                    return false;
                }
                
                // Show loading state
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
                submitBtn.disabled = true;
            });

            // Image upload preview
            imageUpload.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.querySelector('.col-md-6:last-child');
                        preview.innerHTML = `
                            <div class="image-preview-new">
                                <label class="form-label fw-bold mb-2">
                                    <i class="bi bi-image me-2"></i>New Image Preview:
                                </label>
                                <div class="image-preview">
                                    <img src="${e.target.result}" alt="Preview" class="img-fluid rounded shadow-sm" />
                                </div>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Real-time ingredient validation
            const ingredientCheckboxes = document.querySelectorAll("input[name='ingredientIds']");
            ingredientCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedBoxes = document.querySelectorAll("input[name='ingredientIds']:checked");
                    if (checkedBoxes.length > 0) {
                        ingredientError.style.display = "none";
                    }
                });
            });

            // Enhanced price validation
            $.validator.addMethod("price", function(value, element) {
                return this.optional(element) || /^(\d+([.,]\d{1,2})?)$/.test(value);
            }, "Please enter a valid price.");

            // Form field animations
            const formInputs = document.querySelectorAll('.form-floating input, .form-floating textarea');
            formInputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.classList.add('focused');
                });
                input.addEventListener('blur', function() {
                    if (!this.value) {
                        this.parentElement.classList.remove('focused');
                    }
                });
            });

            // Upload area styling
            const uploadArea = document.querySelector('.upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('drag-over');
                });
                
                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        imageUpload.files = files;
                        imageUpload.dispatchEvent(new Event('change'));
                    }
                });
            }
        });
    </script>

    <style>
        .section-title {
            color: var(--bs-primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .section-divider {
            border-color: var(--bs-primary);
            opacity: 0.3;
            margin-bottom: 1.5rem;
        }
        
        .upload-area {
            position: relative;
            border: 2px dashed #dee2e6;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .upload-area:hover {
            border-color: var(--bs-primary);
            background: #e3f2fd;
        }
        
        .upload-area.drag-over {
            border-color: var(--bs-success);
            background: #d4edda;
        }
        
        .upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .upload-text {
            pointer-events: none;
        }
        
        .image-preview img {
            max-height: 200px;
            object-fit: cover;
        }
        
        .category-option, .ingredient-option {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }
        
        .category-option:hover, .ingredient-option:hover {
            background-color: #f8f9fa;
        }
        
        .category-option input:checked + label,
        .ingredient-option input:checked + label {
            font-weight: 600;
            color: var(--bs-primary);
        }
        
        .form-floating.focused {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .ingredients-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
        }
        
        .no-image {
            border: 2px dashed #dee2e6;
            border-radius: 0.5rem;
            background: #f8f9fa;
        }
        
        .form-actions {
            background: #f8f9fa;
            margin: -1.5rem -1.5rem -1.5rem -1.5rem;
            padding: 2rem 1.5rem 1.5rem 1.5rem;
            border-radius: 0 0 0.5rem 0.5rem;
        }
    </style>
}
